name: Deploy All Games to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggers

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.5.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build pixi-svelte package (dependency for all games)
        run: pnpm --filter pixi-svelte build

      - name: Build all games with error handling
        run: |
          set +e  # Don't exit on first error
          
          echo "Building games..."
          games=("lines" "cluster" "scatter" "ways" "price" "number-picker")
          # oma-peli excluded - deployed by separate workflow
          failed_builds=()
          
          for game in "${games[@]}"; do
            echo "Building $game..."
            if pnpm --filter $game build; then
              echo "âœ… $game built successfully"
            else
              echo "âŒ $game build failed"
              failed_builds+=($game)
            fi
          done
          
          if [ ${#failed_builds[@]} -gt 0 ]; then
            echo "Failed builds: ${failed_builds[*]}"
          fi
          
          set -e  # Re-enable exit on error

      - name: Create deployment directory structure
        run: |
          mkdir -p deploy
          
          # Copy each game's build to deployment directory
          games=("lines" "cluster" "scatter" "ways" "price" "number-picker")
          # oma-peli excluded - deployed by separate workflow
          
          for game in "${games[@]}"; do
            if [ -d "apps/$game/build" ]; then
              echo "Copying $game build..."
              cp -r apps/$game/build deploy/$game
            else
              echo "Warning: Build directory for $game not found, skipping..."
            fi
          done

      - name: Create cross-platform index.html for game selection
        run: |
          cat > deploy/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
              <meta name="apple-mobile-web-app-capable" content="yes">
              <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
              <meta name="mobile-web-app-capable" content="yes">
              <title>Web SDK Casino Games - Cross Platform</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'proxima-nova', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
                      color: #ffffff;
                      min-height: 100vh;
                      min-height: calc(var(--vh, 1vh) * 100);
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      -webkit-font-smoothing: antialiased;
                      -moz-osx-font-smoothing: grayscale;
                      
                      /* Cross-platform fixes */
                      --vh: 1vh;
                      --safe-area-top: env(safe-area-inset-top, 0px);
                      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
                      padding-top: var(--safe-area-top);
                      padding-bottom: var(--safe-area-bottom);
                  }
                  
                  .container {
                      max-width: 800px;
                      padding: 2rem;
                      text-align: center;
                      width: 100%;
                  }
                  
                  h1 {
                      font-size: clamp(1.8rem, 4vw, 2.5rem);
                      margin-bottom: 1rem;
                      background: linear-gradient(45deg, #ffd700, #ffed4a);
                      -webkit-background-clip: text;
                      -webkit-text-fill-color: transparent;
                      background-clip: text;
                  }
                  
                  .subtitle {
                      font-size: clamp(1rem, 2.5vw, 1.2rem);
                      margin-bottom: 3rem;
                      opacity: 0.8;
                  }
                  
                  .platform-info {
                      margin-bottom: 2rem;
                      padding: 1rem;
                      background: rgba(255, 255, 255, 0.05);
                      border-radius: 8px;
                      font-size: 0.9rem;
                  }
                  
                  .games-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                      gap: 1.5rem;
                      margin-bottom: 2rem;
                  }
                  
                  .game-card {
                      background: rgba(255, 255, 255, 0.1);
                      border-radius: 12px;
                      padding: 1.5rem;
                      text-decoration: none;
                      color: inherit;
                      transition: all 0.3s ease;
                      border: 2px solid transparent;
                      touch-action: manipulation; /* iOS optimization */
                  }
                  
                  .game-card:hover,
                  .game-card:focus {
                      transform: translateY(-5px);
                      background: rgba(255, 255, 255, 0.15);
                      border-color: #ffd700;
                      box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2);
                      outline: none;
                  }
                  
                  .game-title {
                      font-size: 1.3rem;
                      font-weight: bold;
                      margin-bottom: 0.5rem;
                  }
                  
                  .game-desc {
                      font-size: 0.9rem;
                      opacity: 0.7;
                  }
                  
                  .footer {
                      margin-top: 3rem;
                      opacity: 0.6;
                      font-size: 0.85rem;
                  }
                  
                  /* Mobile-specific optimizations */
                  @media (max-width: 768px) {
                      .container { padding: 1rem; }
                      .games-grid { 
                          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                          gap: 1rem; 
                      }
                      .game-card { padding: 1rem; }
                  }
                  
                  /* iOS safe area support */
                  @supports (padding: max(0px)) {
                      body {
                          padding-top: max(var(--safe-area-top), 1rem);
                          padding-bottom: max(var(--safe-area-bottom), 1rem);
                      }
                  }
                  
                  /* High DPI displays */
                  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
                      body { 
                          -webkit-font-smoothing: antialiased; 
                      }
                  }
              </style>
              <script>
                  // Cross-platform viewport height fix
                  function setViewportHeight() {
                      const vh = window.innerHeight * 0.01;
                      document.documentElement.style.setProperty('--vh', vh + 'px');
                  }
                  setViewportHeight();
                  window.addEventListener('resize', setViewportHeight);
                  window.addEventListener('orientationchange', () => {
                      setTimeout(setViewportHeight, 300);
                  });
                  
                  // Platform detection
                  function detectPlatform() {
                      const ua = navigator.userAgent;
                      const platform = navigator.platform;
                      
                      if (/iPad|iPhone|iPod/.test(ua) || (platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
                          return 'iOS';
                      } else if (/Android/.test(ua)) {
                          return 'Android';
                      } else if (/Mac OS X/.test(ua)) {
                          return 'macOS';
                      } else if (/Windows/.test(ua)) {
                          return 'Windows';
                      } else if (/Linux/.test(ua)) {
                          return 'Linux';
                      }
                      return 'Unknown';
                  }
                  
                  window.addEventListener('DOMContentLoaded', () => {
                      const platform = detectPlatform();
                      const infoEl = document.querySelector('.platform-info');
                      if (infoEl) {
                          infoEl.innerHTML = 'ðŸ”¥ Optimized for ' + platform + ' â€¢ Touch & Keyboard Friendly';
                      }
                  });
              </script>
          </head>
          <body>
              <div class="container">
                  <h1>ðŸŽ° Web SDK Casino Games</h1>
                  <p class="subtitle">Cross-Platform â€¢ Svelte 5 + PixiJS 8 + TypeScript</p>
                  
                  <div class="platform-info">
                      ðŸš€ Universal Compatibility â€¢ iOS, Android, macOS, Windows, Linux
                  </div>
                  
                  <div class="games-grid">
                      <a href="./lines/" class="game-card">
                          <div class="game-title">Lines Game</div>
                          <div class="game-desc">Classic payline slot game</div>
                      </a>
                      <a href="./cluster/" class="game-card">
                          <div class="game-title">Cluster Game</div>
                          <div class="game-desc">Cluster pays slot game</div>
                      </a>
                      <a href="./scatter/" class="game-card">
                          <div class="game-title">Scatter Game</div>
                          <div class="game-desc">Scatter symbol game</div>
                      </a>
                      <a href="./ways/" class="game-card">
                          <div class="game-title">Ways Game</div>
                          <div class="game-desc">243 ways to win</div>
                      </a>
                      <a href="./price/" class="game-card">
                          <div class="game-title">Price Game</div>
                          <div class="game-desc">Price-based gameplay</div>
                      </a>
                      <a href="./number-picker/" class="game-card">
                          <div class="game-title">Number Picker</div>
                          <div class="game-desc">Number selection game</div>
                      </a>
                      <a href="./oma-peli/" class="game-card">
                          <div class="game-title">Oma Peli</div>
                          <div class="game-desc">Custom Finnish game</div>
                      </a>
                  </div>
                  
                  <div class="footer">
                      Cross-Platform Layout Engine â€¢ iOS Safe Area â€¢ Android Viewport â€¢ Linux Font Rendering
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy
          branch: gh-pages
          clean: true
